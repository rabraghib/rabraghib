name: ðŸš€ Build, Release & Deploy
on:
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  changelog:
    runs-on: ubuntu-20.04
    outputs:
      released: ${{ steps.releaser.outputs.released }}
      tag: ${{ steps.releaser.outputs.tag }}
      version: ${{ steps.releaser.outputs.version }}
      release_notes: ${{ steps.releaser.outputs.release_notes }}
      artifacts-key: 'release-artifacts'
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
          cache: 'yarn'
      - run: yarn --frozen-lockfile
      - name: Build and commit changes
        run: |
          yarn build content --skip-nx-cache
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "docs: :memo: build README (ejs template)" || true
          git push
      - uses: chaospad/releaser@v1
        id: releaser
        with:
          birthday: '2004-04-13'
          version: '{years}.{months}.{bump}'
          bump-files: |
            projects/**/package.json
            package.json
          output-file: projects/CHANGELOG.md

  build:
    if: needs.changelog.outputs.released
    needs: changelog
    uses: ./.github/workflows/re-build.yml
    with:
      artifacts-key: ${{ needs.changelog.outputs.artifacts-key }}
      tag_name: ${{ needs.changelog.outputs.tag }}

  gh-release:
    needs: [build, changelog]
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2

      - uses: actions/download-artifact@v2
        with:
          name: ${{ needs.changelog.outputs.artifacts-key }}
          path: dist

      - uses: softprops/action-gh-release@v1
        with:
          name: '${{ needs.changelog.outputs.tag }} ðŸŽ‰'
          tag_name: ${{ needs.changelog.outputs.tag }}
          body: ${{ needs.changelog.outputs.release_notes }}
          files: |
            dist/artifacts/*

  deploy:
    needs: [build, changelog]
    uses: ./.github/workflows/re-deploy.yml
    with:
      artifacts-key: ${{ needs.changelog.outputs.artifacts-key }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      token: ${{ secrets.GITHUB_TOKEN }}
      FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_RABRAGHIB }}
